version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: 22
    commands:
      - npm install -g sst

  pre_build:
    commands:
      - echo "Moving into deploy folder..."
      - cd deploy
      - echo "Installing local dependencies..."
      - npm ci || npm install
      - echo "Stage: $STAGE"

  build:
    commands:
      - echo "Deploying SST app to stage: '$STAGE' cluster: '$CLUSTER_NAME' service: '$SERVICE_NAME'"
      - sst deploy --stage=$STAGE --verbose --print-logs
      - echo "Waiting for ECS to be stable..."
      - aws ecs wait services-stable --cluster $CLUSTER_NAME --services $SERVICE_NAME
      - echo "Done!"
