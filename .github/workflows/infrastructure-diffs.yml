name: Infrastructure Diffs

on:
  pull_request:
    paths:
      - "deploy/**"

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  AWS_REGION: us-west-2

jobs:
  main:
    name: Infrastructure Diff
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: npm

      - run: npm ci

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Pulumi
        uses: pulumi/actions@v6
        with:
          pulumi-version: "^3"

      - name: Run Pulumi Preview and build comment
        id: preview
        run: |
          declare -A STAGES=([dev]=develop [qa]=qa [prod]=master)
          HAS_CHANGES=false
          HAS_ERRORS=false

          echo "## Infrastructure Diff" > /tmp/pr-comment.md
          echo "" >> /tmp/pr-comment.md
          echo "This PR makes infrastructure changes in at least one environment." >> /tmp/pr-comment.md

          for env in dev qa prod; do
            stage="${STAGES[$env]}"

            # Use currently deployed image to avoid diffs from code-only changes
            TASK_DEF=$(aws ecs describe-services --cluster "gp-${stage}-fargateCluster" --services "gp-api-${stage}" --query 'services[0].taskDefinition' --output text)
            export IMAGE_URI=$(aws ecs describe-task-definition --task-definition "$TASK_DEF" --query 'taskDefinition.containerDefinitions[0].image' --output text)

            npm run --silent infra diff $env -- --json > /tmp/preview-$env.json 2>&1 || true

            # Count changes
            CHANGES=$(jq '[.changeSummary.create, .changeSummary.update, .changeSummary.delete, .changeSummary.replace | values] | add // 0' /tmp/preview-$env.json)

            # Check for errors in diagnostics
            ERRORS=$(jq '[.diagnostics // [] | .[] | select(.severity == "error")] | length' /tmp/preview-$env.json)

            echo "### \`$env\`" >> /tmp/pr-comment.md

            # Surface errors first if present
            if [ "$ERRORS" -gt 0 ]; then
              HAS_CHANGES=true
              HAS_ERRORS=true
              echo "⛔ **$ERRORS error(s) during preview:**" >> /tmp/pr-comment.md
              echo '' >> /tmp/pr-comment.md
              echo '```' >> /tmp/pr-comment.md
              jq -r '.diagnostics // [] | .[] | select(.severity == "error") | .message' /tmp/preview-$env.json >> /tmp/pr-comment.md
              echo '```' >> /tmp/pr-comment.md
              echo '' >> /tmp/pr-comment.md
            fi

            if [ "$CHANGES" -gt 0 ]; then
              HAS_CHANGES=true
              jq -r '"**\(.changeSummary | to_entries | map("\(.value) \(.key)") | join(", "))**"' /tmp/preview-$env.json >> /tmp/pr-comment.md
              echo '<details><summary>Show diff</summary>' >> /tmp/pr-comment.md
              echo '' >> /tmp/pr-comment.md
              echo '```diff' >> /tmp/pr-comment.md
              echo "$(npm run --silent infra diff $env 2>&1)" >> /tmp/pr-comment.md
              echo '```' >> /tmp/pr-comment.md
              echo '</details>' >> /tmp/pr-comment.md
            elif [ "$ERRORS" -eq 0 ]; then
              echo "✅ No changes" >> /tmp/pr-comment.md
            fi
            echo "" >> /tmp/pr-comment.md
          done

          echo "has_changes=$HAS_CHANGES" >> $GITHUB_OUTPUT
          echo "has_errors=$HAS_ERRORS" >> $GITHUB_OUTPUT

      - name: Find existing diff comment
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ github.event.number }}
          comment-author: "github-actions[bot]"
          body-includes: "Infrastructure Diff"

      - name: Post or update PR comment
        if: steps.preview.outputs.has_changes == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.number }}
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          edit-mode: replace
          body-path: /tmp/pr-comment.md

      - name: Delete existing comment if no changes
        if: steps.preview.outputs.has_changes == 'false' && steps.find-comment.outputs.comment-id != ''
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.deleteComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: ${{ steps.find-comment.outputs.comment-id }}
            })

      - name: Fail if preview errors
        if: steps.preview.outputs.has_errors == 'true'
        run: |
          echo "::error::Pulumi preview encountered errors. Check the PR comment for details."
          exit 1
