name: Deploy and Test

on:
  push:
    branches: ['develop', 'qa', 'master']

jobs:
  deploy:
    runs-on: ubuntu-latest
    outputs:
      target_env: ${{ steps.set-env.outputs.target_env }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm

      - run: npm ci
      - run: npm run generate
      - run: npx tsc --noEmit

      - name: Map branch to environment
        id: set-env
        shell: bash
        run: |
          BRANCH="${GITHUB_REF_NAME}"
          case "$BRANCH" in
            develop)
              echo "target_env=dev" >> "$GITHUB_OUTPUT"
              ;;
            qa)
              echo "target_env=qa" >> "$GITHUB_OUTPUT"
              ;;
            *)
              echo "Unsupported branch: $BRANCH"; exit 1
              ;;
          esac

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2

      - name: Run CodeBuild
        uses: aws-actions/aws-codebuild-run-build@v1
        with:
          project-name: gp-deploy-build-${{ github.ref_name }}

      - name: Wait for application to be ready
        shell: bash
        run: |
          case "${{ github.ref_name }}" in
            develop)
              CLUSTER="gp-develop-fargateCluster"
              SERVICE="gp-api-develop"
              API_URL="https://gp-api-dev.goodparty.org"
              ;;
            qa)
              CLUSTER="gp-qa-fargateCluster"
              SERVICE="gp-api-qa"
              API_URL="https://gp-api-qa.goodparty.org"
              ;;
            *)
              echo "Unsupported branch"; exit 1
              ;;
          esac

          echo "Waiting for ECS service deployment to complete..."
          aws ecs wait services-stable \
            --cluster "$CLUSTER" \
            --services "$SERVICE" \
            --region us-west-2

          echo "✅ ECS deployment complete"
          echo ""
          echo "Polling ${API_URL}/v1/health until ready..."

          MAX_ATTEMPTS=60
          ATTEMPT=0
          SLEEP_TIME=5

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${API_URL}/v1/health" 2>/dev/null || echo "000")
            
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - HTTP $HTTP_CODE"
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "✅ Application is ready"
              exit 0
            fi
            
            sleep $SLEEP_TIME
          done

          echo "❌ Application failed to become ready after $((MAX_ATTEMPTS * SLEEP_TIME)) seconds"
          exit 1

      - name: Notify Slack on Success (Deploy)
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,commit,author,action,eventName,ref,workflow,took
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack on Failure (Deploy)
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,commit,author,action,eventName,ref,workflow,took
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  tests:
    needs: deploy
    runs-on: ubuntu-latest
    continue-on-error: true
    env:
      TARGET_ENV: ${{ needs.deploy.outputs.target_env }}
      CI: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Set API base URL and test credentials
        shell: bash
        run: |
          case "$TARGET_ENV" in
            dev)
              echo "API_BASE_URL=https://gp-api-dev.goodparty.org" >> "$GITHUB_ENV"
              echo "CANDIDATE_EMAIL=${{ secrets.CANDIDATE_EMAIL }}" >> "$GITHUB_ENV"
              echo "CANDIDATE_PASSWORD=${{ secrets.CANDIDATE_PASSWORD }}" >> "$GITHUB_ENV"
              echo "ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}" >> "$GITHUB_ENV"
              echo "ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}" >> "$GITHUB_ENV"
              echo "CANDIDATE_ID=${{ secrets.DEV_CANDIDATE_ID }}" >> "$GITHUB_ENV"
              echo "CAMPAIGN_SLUG=${{ secrets.DEV_CAMPAIGN_SLUG }}" >> "$GITHUB_ENV"
              ;;
            qa)
              echo "API_BASE_URL=https://gp-api-qa.goodparty.org" >> "$GITHUB_ENV"
              echo "CANDIDATE_EMAIL=${{ secrets.CANDIDATE_EMAIL }}" >> "$GITHUB_ENV"
              echo "CANDIDATE_PASSWORD=${{ secrets.CANDIDATE_PASSWORD }}" >> "$GITHUB_ENV"
              echo "ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}" >> "$GITHUB_ENV"
              echo "ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}" >> "$GITHUB_ENV"
              echo "CANDIDATE_ID=${{ secrets.QA_CANDIDATE_ID }}" >> "$GITHUB_ENV"
              echo "CAMPAIGN_SLUG=${{ secrets.QA_CAMPAIGN_SLUG }}" >> "$GITHUB_ENV"
              ;;
            *)
              echo "Unknown environment: $TARGET_ENV"; exit 1
              ;;
          esac

      - name: Verify environment health
        shell: bash
        run: |
          echo "Verifying ${API_BASE_URL}/v1/health is responding..."
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${API_BASE_URL}/v1/health") || true
          if [ "$STATUS" = "200" ]; then
            echo "✅ Health endpoint is responding"
          else
            echo "⚠️ Health endpoint returned $STATUS (expected 200)"
            exit 1
          fi

      - name: Run Playwright tests
        run: npm run test:e2e

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-reports-${{ env.TARGET_ENV }}-${{ github.sha }}
          path: |
            e2e-tests/playwright-report
            e2e-tests/test-results

      - name: Parse test results
        if: failure()
        id: test-results
        shell: bash
        run: |
          if [ -f "e2e-tests/test-results/results.json" ]; then
            FAILED_TESTS=$(cat e2e-tests/test-results/results.json | jq -r '.suites[].specs[] | select(.ok == false) | .title' | head -10 | sed 's/^/• /')
            if [ -z "$FAILED_TESTS" ]; then
              FAILED_TESTS="• Unable to parse test results"
            fi
            FAILED_COUNT=$(cat e2e-tests/test-results/results.json | jq '[.suites[].specs[] | select(.ok == false)] | length')
            echo "failed_tests<<EOF" >> $GITHUB_OUTPUT
            echo "$FAILED_TESTS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "failed_count=$FAILED_COUNT" >> $GITHUB_OUTPUT
          else
            echo "failed_tests=• Test results file not found" >> $GITHUB_OUTPUT
            echo "failed_count=Unknown" >> $GITHUB_OUTPUT
          fi

      - name: Notify Slack on Test Success
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: '✅ Playwright Tests Completed (Informational)',
              attachments: [{
                color: 'good',
                text: `${{ github.repository }} - ${{ github.ref_name }} by ${{ github.actor }}\nEnvironment: ${{ env.TARGET_ENV }}\nTests passed but are non-blocking during stabilization.\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View workflow run>`
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack on Test Failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: '⚠️ Playwright Tests Failed (Non-blocking)',
              attachments: [{
                color: 'warning',
                text: `${{ github.repository }} - ${{ github.ref_name }} by ${{ github.actor }}\nEnvironment: ${{ env.TARGET_ENV }}\nFailed: ${{ steps.test-results.outputs.failed_count || 'Unknown' }} test(s)\n\nFailed Tests:\n${{ steps.test-results.outputs.failed_tests || 'Unable to determine' }}\n\nThis is informational only and does not block deployment.\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View workflow run>`
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
