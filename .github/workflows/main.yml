name: Deploy and Test

on:
  push:
    branches: ["develop", "qa", "master"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    outputs:
      target_env: ${{ steps.set-env.outputs.target_env }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm

      - run: npm ci
      - run: npm run generate
      - run: npx tsc --noEmit

      - name: Map branch to environment
        id: set-env
        shell: bash
        run: |
          BRANCH="${GITHUB_REF_NAME}"
          case "$BRANCH" in
            develop)
              echo "target_env=dev" >> "$GITHUB_OUTPUT"
              ;;
            qa)
              echo "target_env=qa" >> "$GITHUB_OUTPUT"
              ;;
            master)
              echo "target_env=prod" >> "$GITHUB_OUTPUT"
              ;;
            *)
              echo "Unsupported branch: $BRANCH"; exit 1
              ;;
          esac

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2

      - name: Install Pulumi
        uses: pulumi/actions@v6
        with:
          pulumi-version: "^3"

      - name: Run Pulumi Deploy
        working-directory: deploy/pulumi
        env:
          PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}
        run: |
          npm ci
          sh ./deploy.sh ${{ steps.set-env.outputs.target_env }}
        # ignore failures for now, until this is proven to run successfully
        continue-on-error: true

      - name: Run CodeBuild
        uses: aws-actions/aws-codebuild-run-build@v1
        with:
          project-name: gp-deploy-build-${{ github.ref_name }}

      - name: Wait for ECS deployment
        shell: bash
        run: |
          case "${{ github.ref_name }}" in
            develop)
              CLUSTER="gp-develop-fargateCluster"
              SERVICE="gp-api-develop"
              ;;
            qa)
              CLUSTER="gp-qa-fargateCluster"
              SERVICE="gp-api-qa"
              ;;
            master)
              CLUSTER="gp-master-fargateCluster"
              SERVICE="gp-api-master"
              ;;
            *)
              echo "Unsupported branch"; exit 1
              ;;
          esac

          echo "Waiting for ECS service deployment to complete..."
          aws ecs wait services-stable \
            --cluster "$CLUSTER" \
            --services "$SERVICE" \
            --region us-west-2

          echo "✅ ECS deployment complete"

      - name: Notify Slack on Success (Deploy)
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,commit,author,action,eventName,ref,workflow,took
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack on Failure (Deploy)
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,commit,author,action,eventName,ref,workflow,took
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  tests:
    needs: deploy
    if: github.ref_name != 'master'
    runs-on: ubuntu-latest
    continue-on-error: true
    env:
      TARGET_ENV: ${{ needs.deploy.outputs.target_env }}
      CI: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Set API base URL and test credentials
        shell: bash
        run: |
          case "$TARGET_ENV" in
            dev)
              echo "API_BASE_URL=https://gp-api-dev.goodparty.org" >> "$GITHUB_ENV"
              echo "CANDIDATE_EMAIL=${{ secrets.CANDIDATE_EMAIL }}" >> "$GITHUB_ENV"
              echo "CANDIDATE_PASSWORD=${{ secrets.CANDIDATE_PASSWORD }}" >> "$GITHUB_ENV"
              echo "ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}" >> "$GITHUB_ENV"
              echo "ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}" >> "$GITHUB_ENV"
              echo "CANDIDATE_ID=${{ secrets.DEV_CANDIDATE_ID }}" >> "$GITHUB_ENV"
              echo "CAMPAIGN_SLUG=${{ secrets.DEV_CAMPAIGN_SLUG }}" >> "$GITHUB_ENV"
              ;;
            qa)
              echo "API_BASE_URL=https://gp-api-qa.goodparty.org" >> "$GITHUB_ENV"
              echo "CANDIDATE_EMAIL=${{ secrets.CANDIDATE_EMAIL }}" >> "$GITHUB_ENV"
              echo "CANDIDATE_PASSWORD=${{ secrets.CANDIDATE_PASSWORD }}" >> "$GITHUB_ENV"
              echo "ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}" >> "$GITHUB_ENV"
              echo "ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}" >> "$GITHUB_ENV"
              echo "CANDIDATE_ID=${{ secrets.QA_CANDIDATE_ID }}" >> "$GITHUB_ENV"
              echo "CAMPAIGN_SLUG=${{ secrets.QA_CAMPAIGN_SLUG }}" >> "$GITHUB_ENV"
              ;;
            prod)
              HEALTH_URL="https://gp-api.goodparty.org/v1/health"
              ;;
            *)
              echo "Unknown environment: $TARGET_ENV"; exit 1
              ;;
          esac

      - name: Verify environment health
        shell: bash
        run: |
          echo "Verifying ${API_BASE_URL}/v1/health is responding..."
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${API_BASE_URL}/v1/health") || true
          if [ "$STATUS" = "200" ]; then
            echo "✅ Health endpoint is responding"
          else
            echo "⚠️ Health endpoint returned $STATUS (expected 200)"
            exit 1
          fi

      - name: Run Playwright tests
        id: run-tests
        run: npm run test:e2e

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-reports-${{ env.TARGET_ENV }}-${{ github.sha }}
          path: |
            e2e-tests/playwright-report
            e2e-tests/test-results

      - name: Parse test results
        if: always()
        id: test-results
        shell: bash
        run: |
          if [ -f "e2e-tests/test-results/results.json" ]; then
            echo "Found results.json, parsing test results..."
            
            TOTAL_TESTS=$(cat e2e-tests/test-results/results.json | jq '[.. | .specs? // empty | .[]] | length' 2>/dev/null || echo "0")
            FAILED_COUNT=$(cat e2e-tests/test-results/results.json | jq '[.. | .specs? // empty | .[] | select(.ok == false)] | length' 2>/dev/null || echo "0")
            PASSED_COUNT=$(cat e2e-tests/test-results/results.json | jq '[.. | .specs? // empty | .[] | select(.ok == true)] | length' 2>/dev/null || echo "0")
            
            echo "Parsed: Total=$TOTAL_TESTS, Failed=$FAILED_COUNT, Passed=$PASSED_COUNT"
            
            echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
            echo "failed_count=$FAILED_COUNT" >> $GITHUB_OUTPUT
            echo "passed_count=$PASSED_COUNT" >> $GITHUB_OUTPUT
            
            if [ "$FAILED_COUNT" -gt 0 ]; then
              FAILED_TESTS=$(cat e2e-tests/test-results/results.json | jq -r '[.. | .specs? // empty | .[] | select(.ok == false) | .title] | .[:10] | map("• " + .) | join("\\n")' 2>/dev/null || echo "• Failed to parse test names")
              if [ -z "$FAILED_TESTS" ]; then
                FAILED_TESTS="• $FAILED_COUNT test(s) failed but names could not be parsed"
              fi
              echo "failed_tests=$FAILED_TESTS" >> $GITHUB_OUTPUT
              echo "tests_ran=true" >> $GITHUB_OUTPUT
            else
              echo "failed_tests=" >> $GITHUB_OUTPUT
              if [ "$TOTAL_TESTS" -gt 0 ]; then
                echo "tests_ran=true" >> $GITHUB_OUTPUT
              else
                echo "tests_ran=false" >> $GITHUB_OUTPUT
              fi
            fi
          else
            echo "⚠️  results.json file not found - tests may not have run"
            echo "failed_tests=• Test results file not found (tests may not have started)" >> $GITHUB_OUTPUT
            echo "failed_count=0" >> $GITHUB_OUTPUT
            echo "passed_count=0" >> $GITHUB_OUTPUT
            echo "total_tests=0" >> $GITHUB_OUTPUT
            echo "tests_ran=false" >> $GITHUB_OUTPUT
          fi

      - name: Notify Slack on Test Success
        if: steps.run-tests.outcome == 'success'
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: '✅ Playwright Tests Passed',
              attachments: [{
                color: 'good',
                text: `${{ github.repository }} - ${{ github.ref_name }} by ${{ github.actor }}\nEnvironment: ${{ env.TARGET_ENV }}\n✅ ${{ steps.test-results.outputs.passed_count }}/${{ steps.test-results.outputs.total_tests }} tests passed\n\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View workflow run>`
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack on Test Failure
        if: steps.run-tests.outcome == 'failure' || failure()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "${{ steps.test-results.outputs.tests_ran == 'true' && '⚠️ Playwright Tests Failed (Non-blocking)' || '❌ Test Environment Not Ready' }}",
              "attachments": [{
                "color": "${{ steps.test-results.outputs.tests_ran == 'true' && 'warning' || 'danger' }}",
                "text": "${{ github.repository }} - ${{ github.ref_name }} by ${{ github.actor }}\nEnvironment: ${{ env.TARGET_ENV }}\n\n${{ steps.test-results.outputs.tests_ran == 'true' && format('❌ {0}/{1} tests failed\n✅ {2}/{1} tests passed\n\nFailed Tests:\n{3}\n\nTests are non-blocking during stabilization.', steps.test-results.outputs.failed_count, steps.test-results.outputs.total_tests, steps.test-results.outputs.passed_count, steps.test-results.outputs.failed_tests) || '❌ Tests did not run - environment health check failed or test setup error occurred.\n\nThe application may not be ready or there was an issue with test initialization.' }}\n\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View workflow run>"
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
