name: Deploy and Test

on:
  push:
    branches: ['develop', 'qa', 'master']

jobs:
  deploy:
    runs-on: ubuntu-latest
    outputs:
      target_env: ${{ steps.set-env.outputs.target_env }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm

      - run: npm ci
      - run: npm run generate
      - run: npx tsc --noEmit

      - name: Map branch to environment
        id: set-env
        shell: bash
        run: |
          BRANCH="${GITHUB_REF_NAME}"
          case "$BRANCH" in
            develop)
              echo "target_env=dev" >> "$GITHUB_OUTPUT"
              ;;
            qa)
              echo "target_env=qa" >> "$GITHUB_OUTPUT"
              ;;
            *)
              echo "Unsupported branch: $BRANCH"; exit 1
              ;;
          esac

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2

      - name: Run CodeBuild
        uses: aws-actions/aws-codebuild-run-build@v1
        with:
          project-name: gp-deploy-build-${{ github.ref_name }}

      - name: Wait for application to be ready
        shell: bash
        run: |
          case "${{ github.ref_name }}" in
            develop)
              CLUSTER="gp-develop-fargateCluster"
              SERVICE="gp-api-develop"
              API_URL="https://gp-api-dev.goodparty.org"
              ;;
            qa)
              CLUSTER="gp-qa-fargateCluster"
              SERVICE="gp-api-qa"
              API_URL="https://gp-api-qa.goodparty.org"
              ;;
            *)
              echo "Unsupported branch"; exit 1
              ;;
          esac

          echo "Waiting for ECS service deployment to complete..."
          aws ecs wait services-stable \
            --cluster "$CLUSTER" \
            --services "$SERVICE" \
            --region us-west-2

          echo "‚úÖ ECS deployment complete"
          echo ""
          echo "Waiting 2 minutes for application to fully initialize..."
          sleep 120
          echo ""
          echo "Polling ${API_URL}/v1/health until ready..."

          MAX_ATTEMPTS=60
          ATTEMPT=0
          SLEEP_TIME=5
          SUCCESS_COUNT=0
          REQUIRED_SUCCESS=5

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${API_URL}/v1/health" 2>/dev/null || echo "000")
            
            if [ "$HTTP_CODE" = "200" ]; then
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - HTTP $HTTP_CODE ‚úÖ (success $SUCCESS_COUNT/$REQUIRED_SUCCESS)"
              
              if [ $SUCCESS_COUNT -ge $REQUIRED_SUCCESS ]; then
                echo ""
                echo "‚úÖ Application is ready and stable (5 consecutive successful health checks)"
                exit 0
              fi
            else
              SUCCESS_COUNT=0
              echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - HTTP $HTTP_CODE ‚è≥ (resetting counter)"
            fi
            
            sleep $SLEEP_TIME
          done

          echo ""
          echo "‚ùå Application failed to become ready after 120s initial + $((MAX_ATTEMPTS * SLEEP_TIME))s of polling"
          exit 1

      - name: Notify Slack on Success (Deploy)
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,commit,author,action,eventName,ref,workflow,took
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack on Failure (Deploy)
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,commit,author,action,eventName,ref,workflow,took
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  tests:
    needs: deploy
    runs-on: ubuntu-latest
    continue-on-error: true
    env:
      TARGET_ENV: ${{ needs.deploy.outputs.target_env }}
      CI: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Set API base URL and test credentials
        shell: bash
        run: |
          case "$TARGET_ENV" in
            dev)
              echo "API_BASE_URL=https://gp-api-dev.goodparty.org" >> "$GITHUB_ENV"
              echo "CANDIDATE_EMAIL=${{ secrets.CANDIDATE_EMAIL }}" >> "$GITHUB_ENV"
              echo "CANDIDATE_PASSWORD=${{ secrets.CANDIDATE_PASSWORD }}" >> "$GITHUB_ENV"
              echo "ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}" >> "$GITHUB_ENV"
              echo "ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}" >> "$GITHUB_ENV"
              echo "CANDIDATE_ID=${{ secrets.DEV_CANDIDATE_ID }}" >> "$GITHUB_ENV"
              echo "CAMPAIGN_SLUG=${{ secrets.DEV_CAMPAIGN_SLUG }}" >> "$GITHUB_ENV"
              ;;
            qa)
              echo "API_BASE_URL=https://gp-api-qa.goodparty.org" >> "$GITHUB_ENV"
              echo "CANDIDATE_EMAIL=${{ secrets.CANDIDATE_EMAIL }}" >> "$GITHUB_ENV"
              echo "CANDIDATE_PASSWORD=${{ secrets.CANDIDATE_PASSWORD }}" >> "$GITHUB_ENV"
              echo "ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}" >> "$GITHUB_ENV"
              echo "ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}" >> "$GITHUB_ENV"
              echo "CANDIDATE_ID=${{ secrets.QA_CANDIDATE_ID }}" >> "$GITHUB_ENV"
              echo "CAMPAIGN_SLUG=${{ secrets.QA_CAMPAIGN_SLUG }}" >> "$GITHUB_ENV"
              ;;
            *)
              echo "Unknown environment: $TARGET_ENV"; exit 1
              ;;
          esac

      - name: Verify environment health
        shell: bash
        run: |
          echo "Environment: $TARGET_ENV"
          echo "API Base URL: ${API_BASE_URL}"
          echo ""
          echo "Verifying ${API_BASE_URL}/v1/health is responding..."

          for i in {1..3}; do
            echo "Health check attempt $i/3..."
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${API_BASE_URL}/v1/health" 2>&1) || true
            
            if [ "$STATUS" = "200" ]; then
              echo "‚úÖ Health endpoint returned 200"
              break
            else
              echo "‚ö†Ô∏è Health endpoint returned $STATUS"
              if [ $i -lt 3 ]; then
                echo "Waiting 10s before retry..."
                sleep 10
              fi
            fi
          done

          if [ "$STATUS" != "200" ]; then
            echo "‚ùå Health endpoint failed after 3 attempts"
            exit 1
          fi

          echo ""
          echo "Waiting 15 seconds for application to settle before test load..."
          sleep 15

      - name: Run Playwright tests
        id: run-tests
        env:
          DEBUG: pw:api
        run: |
          echo "üß™ Starting Playwright tests"
          echo "API_BASE_URL: ${API_BASE_URL}"
          echo "CI: ${CI}"
          echo ""
          npm run test:e2e

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-reports-${{ env.TARGET_ENV }}-${{ github.sha }}
          path: |
            e2e-tests/playwright-report
            e2e-tests/test-results

      - name: Parse test results
        if: always()
        id: test-results
        shell: bash
        run: |
          if [ -f "e2e-tests/test-results/results.json" ]; then
            echo "Found results.json, parsing test results..."
            
            TOTAL_TESTS=$(cat e2e-tests/test-results/results.json | jq '[.suites[]?.specs[]?] | length' 2>/dev/null || echo "0")
            FAILED_COUNT=$(cat e2e-tests/test-results/results.json | jq '[.suites[]?.specs[]? | select(.ok == false)] | length' 2>/dev/null || echo "0")
            PASSED_COUNT=$(cat e2e-tests/test-results/results.json | jq '[.suites[]?.specs[]? | select(.ok == true)] | length' 2>/dev/null || echo "0")
            
            echo "Parsed: Total=$TOTAL_TESTS, Failed=$FAILED_COUNT, Passed=$PASSED_COUNT"
            
            echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
            echo "failed_count=$FAILED_COUNT" >> $GITHUB_OUTPUT
            echo "passed_count=$PASSED_COUNT" >> $GITHUB_OUTPUT
            
            if [ "$FAILED_COUNT" -gt 0 ]; then
              FAILED_TESTS=$(cat e2e-tests/test-results/results.json | jq -r '.suites[]?.specs[]? | select(.ok == false) | .title' 2>/dev/null | head -10 | sed 's/^/‚Ä¢ /' || echo "‚Ä¢ Failed to parse test names")
              if [ -z "$FAILED_TESTS" ]; then
                FAILED_TESTS="‚Ä¢ $FAILED_COUNT test(s) failed but names could not be parsed"
              fi
              echo "failed_tests<<EOF" >> $GITHUB_OUTPUT
              echo "$FAILED_TESTS" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
              echo "tests_ran=true" >> $GITHUB_OUTPUT
            else
              echo "failed_tests=" >> $GITHUB_OUTPUT
              if [ "$TOTAL_TESTS" -gt 0 ]; then
                echo "tests_ran=true" >> $GITHUB_OUTPUT
              else
                echo "tests_ran=false" >> $GITHUB_OUTPUT
              fi
            fi
          else
            echo "‚ö†Ô∏è  results.json file not found - tests may not have run"
            echo "failed_tests=‚Ä¢ Test results file not found (tests may not have started)" >> $GITHUB_OUTPUT
            echo "failed_count=0" >> $GITHUB_OUTPUT
            echo "passed_count=0" >> $GITHUB_OUTPUT
            echo "total_tests=0" >> $GITHUB_OUTPUT
            echo "tests_ran=false" >> $GITHUB_OUTPUT
          fi

      - name: Notify Slack on Test Success
        if: steps.run-tests.outcome == 'success'
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: '‚úÖ Playwright Tests Passed',
              attachments: [{
                color: 'good',
                text: `${{ github.repository }} - ${{ github.ref_name }} by ${{ github.actor }}\nEnvironment: ${{ env.TARGET_ENV }}\n‚úÖ ${{ steps.test-results.outputs.passed_count }}/${{ steps.test-results.outputs.total_tests }} tests passed\n\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View workflow run>`
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack on Test Failure
        if: steps.run-tests.outcome == 'failure' || failure()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "${{ steps.test-results.outputs.tests_ran == 'true' && '‚ö†Ô∏è Playwright Tests Failed (Non-blocking)' || '‚ùå Test Environment Not Ready' }}",
              "attachments": [{
                "color": "${{ steps.test-results.outputs.tests_ran == 'true' && 'warning' || 'danger' }}",
                "text": "${{ github.repository }} - ${{ github.ref_name }} by ${{ github.actor }}\nEnvironment: ${{ env.TARGET_ENV }}\n\n${{ steps.test-results.outputs.tests_ran == 'true' && format('‚ùå {0}/{1} tests failed\n‚úÖ {2}/{1} tests passed\n\nFailed Tests:\n{3}\n\nTests are non-blocking during stabilization.', steps.test-results.outputs.failed_count, steps.test-results.outputs.total_tests, steps.test-results.outputs.passed_count, steps.test-results.outputs.failed_tests) || '‚ùå Tests did not run - environment health check failed or test setup error occurred.\n\nThe application may not be ready or there was an issue with test initialization.' }}\n\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View workflow run>"
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
